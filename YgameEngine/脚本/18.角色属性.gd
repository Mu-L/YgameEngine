extends Node
# 通用属性类 - 支持完全自定义属性和规则（模块本身不包含任何预设）
class 通用属性:
	# 存储加密的属性值
	var 属性值: Dictionary = {}  # {属性名: 加密值}
	var 属性点=引擎.加解密.浮点数加密(0.0)
	# 配置数据（模块本身不预设任何值，完全由外部定制）
	var 属性规则: Dictionary = {}  # 属性影响规则
	var 基础属性: Dictionary = {}   # 基础属性值,相当于初始属性
	var 职业: String = ""           # 当前职业
	
	# 构造函数
	func _init(初始职业: String = ""):
		职业 = 初始职业
	
	# ==============================================
	# 属性管理
	# ==============================================
	
	# 添加新属性（如果不存在）
	func 添加属性(属性名: String, 初始值: float = 0.0) -> void:
		if 属性名 not in 属性值:
			属性值[属性名] = 引擎.加解密.浮点数加密(初始值)
	
	# 设置属性值（自动加密）
	func 设置属性值(属性名: String, 值: float) -> bool:
		if 属性名 not in 属性值:
			print("属性 "+属性名+"不存在，请先添加属性")
			return false
		
		属性值[属性名] = 引擎.加解密.浮点数加密(值)
		return true
	
	# 获取属性值（自动解密）
	func 获取属性值(属性名: String) -> float:
		if 属性名 not in 属性值:
			return 0.0
		return 引擎.加解密.浮点数解密(属性值[属性名])
	
	# 增加属性值
	func 增加属性值(属性名: String, 增加值: float,关联属性点:bool=false) -> bool:
		if 属性名 not in 属性值:
			return false
			
		#如果需要属性点
		if 关联属性点:
			# 检查属性点是否足够
			if 获取属性点()<增加值:
				print("属性点不足，无法增加属性值")
				return false
		
		var 当前值 = 获取属性值(属性名)
		return 设置属性值(属性名, 当前值 + 增加值)
	
	# 获取所有属性值（解密后）
	func 获取所有属性值() -> Dictionary:
		var 结果 = {}
		for 属性名 in 属性值:
			结果[属性名] = 获取属性值(属性名)
		return 结果
	# ==============================================
	# 属性点操作
	# ==============================================
	
	# 设置属性点（自动加密）
	func 设置属性点(值: float) -> void:
		属性点 = 引擎.加解密.浮点数加密(值)
	
	# 获取属性点（自动解密）
	func 获取属性点() -> float:
		return 引擎.加解密.浮点数解密(属性点)
	
	# 增加属性点
	func 增加属性点(增加值: float) -> void:
		var 当前值 = 获取属性点()
		设置属性点(当前值 + 增加值)
	
	# 减少属性点
	func 减少属性点(减少值: float) -> bool:
		var 当前值 = 获取属性点()
		if 当前值 >= 减少值:
			设置属性点(当前值 - 减少值)
			return true
		# 如果属性点不足，返回false
		return false
	# ==============================================
	# 规则与基础属性配置
	# ==============================================
	
	# 定制属性规则
	# 规则格式: {属性名: {"影响效果": {效果名: {"通用": 数值, "职业": {职业名: 数值}}}}}
	func 定制属性规则(规则: Dictionary) -> void:
		属性规则 = 规则.duplicate(true)
	
	# 添加单个属性的规则
	func 添加属性规则(属性名: String, 规则: Dictionary) -> void:
		属性规则[属性名] = 规则.duplicate(true)
	
	# 定制基础属性
	func 定制基础属性(基础值: Dictionary) -> void:
		基础属性 = 基础值.duplicate(true)
	
	# 添加单个基础属性
	func 添加基础属性(属性名: String, 值: float) -> void:
		基础属性[属性名] = 值
	
	# 设置职业
	func 设置职业(职业名: String) -> void:
		职业 = 职业名
	func 获取职业() -> String:
		return 职业
	
	# ==============================================
	# 属性计算
	# ==============================================
	class 计算结果:
		var 加密数据: Dictionary = {}
		var 加解密工具 = 引擎.加解密  # 引用加密工具
		
		# 构造函数：接收明文结果并加密
		func _init(明文结果: Dictionary):
			for 效果名 in 明文结果:
				加密数据[效果名] = 加解密工具.浮点数加密(明文结果[效果名])
		
		# 获取解密后的属性值
		func 获取属性(效果名: String) -> float:
			if 效果名 not in 加密数据:
				return 0.0
			return 加解密工具.浮点数解密(加密数据[效果名])
			# 新增：获取所有属性（解密后返回字典）
		func 获取所有属性() -> Dictionary:
			var 所有属性 = {}
			for 效果名 in 加密数据:
				所有属性[效果名] = 加解密工具.浮点数解密(加密数据[效果名])
			return 所有属性
	# 计算属性效果
	func 计算属性效果(包含基础: bool = false) -> 计算结果:
		var 属性点 = 获取所有属性值()
		return 计算属性(属性点, 职业, 包含基础)
	
	# 计算最终属性的核心函数
	func 计算属性(属性点: Dictionary, 职业: String, 包含基础: bool = false) -> 计算结果:
		# 初始化结果字典
		var 最终属性 = {}
		if 包含基础:
			最终属性 = 基础属性.duplicate(true)
		else:
			# 从规则中收集所有可能的效果名并初始化为0
			for 属性名 in 属性规则:
				if "影响效果" in 属性规则[属性名]:
					for 效果名 in 属性规则[属性名]["影响效果"]:
						最终属性[效果名] = 0.0
		
		# 遍历每个属性点计算影响
		for 属性名 in 属性点:
			var 点数 = 属性点[属性名]
			if 属性名 not in 属性规则:
				continue  # 跳过无规则的属性
			
			var 影响效果 = 属性规则[属性名].get("影响效果", {})
			for 效果名 in 影响效果:
				var 规则 = 影响效果[效果名]
				
				# 确保效果名存在于结果中
				if 效果名 not in 最终属性:
					最终属性[效果名] = 0.0
				
				# 计算通用加成
				最终属性[效果名] += 点数 * 规则.get("通用", 0.0)
				
				# 计算职业专属加成
				var 职业加成 = 规则.get("职业", {}).get(职业, 0.0)
				最终属性[效果名] += 点数 * 职业加成
		
		# 处理浮点数精度
		for 效果名 in 最终属性:
			最终属性[效果名] = round(最终属性[效果名] * 100) / 100
		
		# 返回临时结果对象（包含当前计算的加密数据）
		return 计算结果.new(最终属性)

# 创建通用属性实例
func 创建属性实例() -> 通用属性:
	return 通用属性.new()

# 使用示例 - 这里引用你之前提供的属性和规则
#func _ready():
	# 1. 创建属性实例
	#var 角色属性 = 创建属性实例()
	#角色属性.设置职业("战士")
	# 2. 添加你提供的属性（力量、敏捷、体力、智力、智慧）
	#角色属性.添加属性("力量")
	#角色属性.添加属性("敏捷")
	#角色属性.添加属性("体力")
	#角色属性.添加属性("智力")
	#角色属性.添加属性("智慧")
	
	# 3. 设置你提供的测试属性点值
	#var 测试属性点 = {
		#"力量": 5,
		#"敏捷": 5,
		#"体力": 5,
		#"智力": 5,
		#"智慧": 5
	#}
	#for 属性名 in 测试属性点:
		#角色属性.设置属性值(属性名, 测试属性点[属性名])
	
	# 4. 应用你提供的属性规则
	#角色属性.定制属性规则({
		#"力量": {
			#"影响效果": {
				#"攻击力": {"通用": 2.0,"职业": {"战士": 2.0, "刺客": 0.5, "法师": 0.0}},
				#"暴击率": {"通用": 0.01 / 5,"职业": {"战士": 0.0, "刺客": 0.0, "法师": 0.0}},
				#"防御": {"通用": 0.0,"职业": {"战士": 0.5, "刺客": 0.0, "法师": 0.2}}
			#}
		#},
		#"敏捷": {
			#"影响效果": {
				#"命中": {"通用": 0.01,"职业": {"战士": 0.0, "刺客": 0.0, "法师": 0.005}},
				#"暴击率": {"通用": 0.0,"职业": {"战士": 0.0, "刺客": 0.01, "法师": 0.0}},
				#"攻击速度": {"通用": 0.0,"职业": {"战士": 0.002, "刺客": 0.01, "法师": 0.0}},
				#"攻击力": {"通用": 0.0,"职业": {"战士": 0.0, "刺客": 0.8, "法师": 0.0}},
				#"闪避": {"通用": 0.003,"职业": {"战士": 0.002, "刺客": 0.005, "法师": 0.003}}
			#}
		#},
		#"体力": {
			#"影响效果": {
				#"生命值": {"通用": 5.0,"职业": {"战士": 3.0, "刺客": 1.0, "法师": 0.5}},
				#"生命值回复": {"通用": 0.1 / 5,"职业": {}},
				#"防御": {"通用": 0.0,"职业": {"战士": 0.3, "刺客": 0.0, "法师": 0.0}}
			#}
		#},
		#"智力": {
			#"影响效果": {
				#"魔力": {"通用": 0.0,"职业": {"战士": 0.0, "刺客": 0.0, "法师": 2.0}},
				#"暴击率": {"通用": 0.005 / 10,"职业": {"法师": 0.003}},
				#"防御": {"通用": 0.0,"职业": {"战士": 0.1, "刺客": 0.0, "法师": 0.0}},
				#"生命值回复": {"通用": 0.0,"职业": {"战士": 0.0, "刺客": 0.01, "法师": 0.0}}
			#}
		#},
		#"智慧": {
			#"影响效果": {
				#"魔法值": {"通用": 3.0,"职业": {"战士": 0.0, "刺客": 0.0, "法师": 2.0}},
				#"魔法值回复": {"通用": 0.1 / 10,"职业": {"法师": 0.01}},
				#"施法速度": {"通用": 0.0,"职业": {"法师": 0.005}},
				#"生命值回复": {"通用": 0.0,"职业": {"战士": 0.005, "刺客": 0.0, "法师": 0.0}},
				#"防御": {"通用": 0.0,"职业": {"战士": 0.0, "刺客": 0.2, "法师": 0.0}},
			#}
		#}
	#})
	
	# 5. 应用你提供的基础属性
	#角色属性.定制基础属性({
		#"攻击力": 0.0,
		#"魔力": 0.0,
		#"防御": 0.0,
		#"生命值": 10.0,  # 初始生命值
		#"魔法值": 10.0,  # 初始魔法值
		#"暴击率": 0.0,
		#"命中": 0.7,  # 初始命中率70%
		#"攻击速度": 1.0,  # 初始攻击速度
		#"施法速度": 0.8,  # 初始施法速度
		#"生命值回复": 0.0,
		#"魔法值回复": 0.0,
		#"闪避": 0.0
	#})
	
	# 6. 计算属性效果（包含基础属性）
#	var 角色效果 = 角色属性.计算属性效果(true)
#	print("角色属性效果: ", 角色效果)
	
	
