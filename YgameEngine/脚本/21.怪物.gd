extends Node

class 怪物:
	# 核心信息与状态
	var 怪物ID: String = ""
	var 名称: String = ""
	var 种族: String = ""
	var 等级: float = 0.0
	var 阵营: String = ""
	var 描述: String = ""
	var 图标路径: String = ""
	
	var 角色状态:引擎.生命魔法类.生命魔法 = 引擎.生命魔法类.生命魔法.new()
	var 数量: int = 1 #这是需要 设置的
	# ==============================================
	# 基础信息单独获取方法（每个属性对应一个）
	# ==============================================
	# 获取怪物ID
	func 获取怪物ID() -> String:
		return 怪物ID
	
	# 获取名称
	func 获取名称() -> String:
		return 名称
	
	# 获取种族
	func 获取种族() -> String:
		return 种族
	
	# 获取等级
	func 获取等级() -> float:
		return 等级
	
	# 获取阵营
	func 获取阵营() -> String:
		return 阵营
	
	# 获取描述
	func 获取描述() -> String:
		return 描述
	
	# 获取图标路径
	func 获取图标路径() -> String:
		return 图标路径
	
	# 数量：获取和设置方法
	func 获取数量() -> int:
		return 数量
	
	func 设置数量(新数量: int) -> void:
		数量 = max(1, 新数量)  # 确保数量至少为1（避免0或负数）
	
	
	# 动态加密属性与技能
	var _加密属性列表: Dictionary = {}
	var 技能列表: Array = []
	var 技能数据库引用: Dictionary
	# 内部数据库缓存（类内自动加载）
	var _NPC数据库: Dictionary = {}
	var _NPC技能数据库: Dictionary = {}
	
	# ==============================================
	# 极简初始化：仅需传入怪物ID
	# ==============================================
	func _init(怪物ID: String, 初始数量: int = 1) -> void:
		self.怪物ID = 怪物ID
		self.数量 = 初始数量
		
		# 类内部自动加载所有需要的数据库
		_加载所有数据库()
		
		# 自动加载怪物数据和技能
		var 加载成功 = _加载数据()
		if 加载成功:
			_加载技能()
		else:
			print(str(怪物ID)+"怪物id初始化失败")
	
	# ==============================================
	# 内部数据库加载（内置到类中）
	# ==============================================
	func _加载所有数据库() -> void:
		# 假设这些数据库加载方法是全局可访问的（与你的原代码一致）
		_NPC数据库 = 引擎.数据库.加载NPC数据库().获取数据库()
		_NPC技能数据库 = 引擎.数据库.加载NPC技能数据库().获取数据库()
		技能数据库引用 = 引擎.数据库.加载技能数据库().获取数据库()
	
	# ==============================================
	# 数据与技能加载（基于内部数据库）
	# ==============================================
	func _加载数据() -> bool:
		if not _NPC数据库.has(怪物ID):
			return false
		
		var 怪物数据 = _NPC数据库[怪物ID]
		名称 = 怪物数据.get("名称", "未知怪物")
		种族 = 怪物数据.get("种族", "未知")
		等级 = 怪物数据.get("等级", 1.0)
		阵营 = 怪物数据.get("阵营", "中立")
		描述 = 怪物数据.get("描述", "无描述")
		图标路径 = 怪物数据.get("图标路径", "")
		
		# 加密自定义属性
		var 原始属性 = 怪物数据.get("属性列表", {})
		for 属性名 in 原始属性:
			_加密属性列表[属性名] = 引擎.加解密.浮点数加密(float(原始属性[属性名]))
		
		return true
	
	func _加载技能() -> void:
		技能列表 = _NPC技能数据库.get(怪物ID, [])
	
	# ==============================================
	# 属性操作（保持不变）
	# ==============================================
	func 获取属性(属性名: String) -> float:
		return 引擎.加解密.浮点数解密(_加密属性列表[属性名]) if _加密属性列表.has(属性名)  else 0.0
	
	func 设置属性(属性名: String, 值: float) -> void:
		var 有效数值 = max(0.0, 值)
		_加密属性列表[属性名] = 引擎.加解密.浮点数加密(有效数值)
		
	
	func 获取所有属性名() -> Array:
		return _加密属性列表.keys()
	
	func 获取技能详情(技能ID: String) -> Dictionary:
		return 技能数据库引用.get(技能ID, {})
	func 随机选择技能() -> Dictionary:
		if 技能列表.is_empty():
			return {}
		var 总几率 = 0.0
		for 技能 in 技能列表:
			总几率 += 技能.几率
		var 随机值 = randf() * 总几率
		var 累计几率 = 0.0
		for 技能 in 技能列表:
			累计几率 += 技能.几率
			if 随机值 <= 累计几率:
				return {"技能ID": 技能.技能, "详情": 获取技能详情(技能.技能), "几率": 技能.几率}
		return {}
#
