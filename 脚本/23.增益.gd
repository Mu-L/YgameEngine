extends Node
class 增益:
	# 存储当前所有激活的buff，结构: {buff_id: {叠加次数, 剩余持续}}
	var 增益管理={}
	var 增益数据库:=引擎.数据库.增益数据库.new().获取数据库()
	var 增益效果数据库:=引擎.数据库.增益效果数据库.new().获取数据库()
	func 添加增益(增益ID: String) -> bool:
		# 验证增益ID是否存在
		if not 增益数据库.获取数据(增益ID):
			引擎.调试.打印("错误：增益ID不存在 - " + 增益ID)
			return false
		
		# 从数据库获取配置
		
		if 增益管理.has(增益ID):#判定已有增益
			## 已存在该增益，处理叠加逻辑
			var 当前增益 = 增益管理[增益ID]
			#
			## 根据规则更新持续时间
			if 增益数据库.获取规则(增益ID)=="重置":
				当前增益.剩余持续=增益数据库.获取持续值(增益ID)
			
			#更新叠加次数（不超过上限）
			var 最大堆叠次数=增益数据库.获取堆叠次数(增益ID)
			当前增益.叠加次数 = min(当前增益.叠加次数 + 1.0, 最大堆叠次数)
		else:
			## 新增增益 - 只存储运行时状态
			增益管理[增益ID] = {
				叠加次数 = 1.0,
				持续类型=增益数据库.获取持续类型(增益ID),
				剩余持续 = 增益数据库.获取持续值(增益ID)
			}
		引擎.调试.打印("成功添加[",增益管理[增益ID].持续类型,"]增益: " + 增益ID + ", 当前叠加次数: " + str(增益管理[增益ID].叠加次数),"持续:",增益管理[增益ID].剩余持续)
		return true
	func 更新时间增益(减少时间: float = 1.0) -> void:
		var 待移除的增益 = []
		
		for 增益ID in 增益管理:
			var 增益数据 = 增益管理[增益ID]
			if 增益数据.持续类型 == "时间":
				增益数据.剩余持续 -= 减少时间
				if 增益数据.剩余持续 <= 0:
					待移除的增益.append(增益ID)
		
		for 增益ID in 待移除的增益:
			移除增益(增益ID)
	# 2. 更新指定ID的次数型增益（默认减少1次）
	func 更新指定次数增益(增益ID: String, 减少次数: float = 1.0) -> void:
		if not 增益管理.has(增益ID):
			return
		
		var 增益数据 = 增益管理[增益ID]
		if 增益数据.持续类型 == "次数":
			增益数据.剩余持续 -= 减少次数
			if 增益数据.剩余持续 <= 0:
				移除增益(增益ID)
	
	# 3. 更新所有次数增益（默认减少1次）
	func 更新次数增益(减少次数: float = 1.0) -> void:
		var 待移除的增益 = []
		
		for 增益ID in 增益管理:
			var 增益数据 = 增益管理[增益ID]
			if 增益数据.持续类型 == "次数":
				增益数据.剩余持续 -= 减少次数
				if 增益数据.剩余持续 <= 0:
					待移除的增益.append(增益ID)
		
		for 增益ID in 待移除的增益:
			移除增益(增益ID)
	func 更新所有增益类型(减少时间: float = 1.0, 减少次数: float = 1) -> void:
		# 直接调用已有的更新方法，避免重复代码
		更新时间增益(减少时间)
		更新次数增益(减少次数)
	# 移除指定增益
	func 移除增益(增益ID: String) -> void:
		if 增益管理.has(增益ID):
			增益管理.erase(增益ID)
	
	# 清除所有增益
	func 清除所有增益() -> void:
		增益管理.clear()
	
	# 获取增益效果（考虑叠加次数）
	func 计算总增益效果()-> Dictionary:
		var 总效果={}
		for 增益ID in 增益管理:
			var 单一效果=计算指定增益效果(增益ID)
			总效果=引擎.数学.字典叠加(总效果,单一效果)
		return 总效果
	#效果乘以叠加次数 收获叠加
	func 计算指定增益效果(增益ID: String) -> Dictionary:
			if not 增益管理.has(增益ID):
				return {}
			
			
			var 基础效果 = 增益数据库.获取效果列表(增益ID)
			var 最终效果 = {}
			var 叠加次数 = 增益管理[增益ID].叠加次数
			
			# 效果乘以叠加次数
			for 属性名 in 基础效果:
				最终效果[属性名] = 基础效果[属性名] * 叠加次数
			
			return 最终效果
	# 检查是否拥有指定增益
	func 检查增益(增益ID: String) -> bool:
		return 增益管理.has(增益ID)
	
	# 获取增益信息
	func 获取增益数据() -> Dictionary:
		return 增益管理.duplicate()
	
	#增益效果模拟
	func 计算增益技能(技能ID:String)->Array:
		return 增益效果数据库.计算增益技能(技能ID)
	func 计算增益物品(物品ID:String)->Array:
		return 增益效果数据库.计算增益物品(物品ID)
